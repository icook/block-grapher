{% extends "base.html" %}
{% block header %}
  <script src="https://code.jquery.com/jquery-2.2.2.min.js" integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=" crossorigin="anonymous"></script>
  <!-- NVD3 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.3/nv.d3.css" rel="stylesheet">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.3/nv.d3.js"></script>
  <script type="text/javascript" src="/static/linePlusLineChart.js"></script>

  <style>
  #main_chart g.nv-context g.nv-scatter g.nv-series-0 path.nv-point
  {
      fill-opacity: 0.3;
      stroke-opacity: 0.2;
  }
  #main_chart g.nv-context g.nv-series-0 path.nv-line
  {
      stroke-opacity: 0;
  }
  </style>
  <script type="text/javascript">
  function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function millisecondsToStr (milliseconds) {
    // TIP: to find current time in milliseconds, use:
    // var  current_time_milliseconds = new Date().getTime();

    function numberEnding (number) {
      return (number > 1) ? 's' : '';
    }

    var temp = Math.floor(milliseconds / 1000);
    var years = Math.floor(temp / 31536000);
    if (years) {
      return years + ' year' + numberEnding(years);
    }
    //TODO: Months! Maybe weeks? 
    var days = Math.floor((temp %= 31536000) / 86400);
    if (days) {
      return days + ' day' + numberEnding(days);
    }
    var hours = Math.floor((temp %= 86400) / 3600);
    if (hours) {
      return hours + ' hour' + numberEnding(hours);
    }
    var minutes = Math.floor((temp %= 3600) / 60);
    if (minutes) {
      return minutes + ' minute' + numberEnding(minutes);
    }
    var seconds = temp % 60;
    if (seconds) {
      return seconds + ' second' + numberEnding(seconds);
    }
    return 'less than a second'; //'just now' //or other string you like;
  }

  var blocks = {{ blocks | tojson }};
  blocks.sort(function (a, b) { return a.height - b.height; });
  blocks.reverse();

  nv.addGraph(function() {
    var lastBlockTime = blocks[0].time;
    var last15 = [];
    var diffLineData = [];
    var subsidyLineData = [];
    var lastFifteenData = [];
    for (i = 1; i < blocks.length; i++) {
      var block = blocks[i];
      var interblockTime = lastBlockTime - block.time;

      // Calculate last 15
      last15.unshift([interblockTime, block.hashes_required]);
      var last15Average = null;
      if (last15.length > 15) {
        last15.pop();
        var totalTime = last15.reduce(function(a, b) { return parseFloat(a) + parseFloat(b[0]); });
        var totalHashes = last15.reduce(function(a, b) { return parseFloat(a) + parseFloat(b[1]); });
        last15Average = totalHashes / totalTime;
      }

      var blockDate = block.time * 1000;
      diffLineData.push({x: blockDate, y: block.difficulty});
      subsidyLineData.push({x: blockDate, y: parseFloat(block.subsidy)});
      lastFifteenData.push({x: blockDate, y: last15Average});
      lastBlockTime = block.time;
    }

    var chart = nv.models.linePlusLineChart()
      .margin({left: 100,
               right: 100});

    chart.xAxis.tickFormat(function(d) { return d3.time.format('%b %d %H:%M:%S')(new Date(d)); });
    chart.y1Axis.tickFormat(d3.format('s,.2f')).showMaxMin(false);
    chart.y2Axis.tickFormat(d3.format(',.2f')).showMaxMin(false);

    d3.select('#main_chart')
        .datum([
            {key: 'Difficulty',
             values: diffLineData},
            {key: 'Subsidy',
             values: subsidyLineData},
            {key: 'Last 15 Average',
             bar: true,
             values: lastFifteenData}
            ])
        
        .transition().duration(100)
        .call(chart);

    nv.utils.windowResize(chart.update);

    return chart;
  });
  </script>
{% endblock %}
{% block body %}
{% set timespan = stop - start %}
{% set midpoint = start + timespan %}
<div class="container">
  <h3>{{ timespan | duration }} of {{ proxy.name }} blocks starting {{ start | human_date }} ({{ start_dt }})</h3>
  Drag an area to zoom, right click to reset to full view
</div>
<svg id="main_chart" style="width: 100%; height: 85%;"></svg>
<div id="block_chart" style="width: 100%; height: 10%;"></div>
<h4>Move forward or backward</h4>
<ul>
  <li><a href="/graph/{{ proxy.name }}/{{ start - timespan }}/{{ stop - timespan }}">Previous {{ timespan | duration }}</a></li>
  <li><a href="/graph/{{ proxy.name }}/{{ start + timespan }}/{{ stop + timespan }}">Next {{ timespan | duration }}</a></li>
</ul>
<h4>Change time window (zoom level)</h4>
<ul>
  {% for span in (3600, 21600, 86400, 604800, 2592000) %}
  {% set halfspan = span // 2 %}
  {% if span != timespan %}
    <li><a href="/graph/{{ proxy.name }}/{{ midpoint - halfspan }}/{{ stop + halfspan }}">View {{ span | duration }}</a></li>
  {% else %}
    <li>Current Timespan</li>
  {% endif %}
  {% endfor %}
</ul>
{% endblock %}
